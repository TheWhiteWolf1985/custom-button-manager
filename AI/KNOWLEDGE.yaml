meta:
  project: "custom-command-sidebar"
  ai_kit_version: "1.0.0"
  updated_at: "2026-02-17"

entities:
  - id: "ext.custom-command-sidebar"
    type: "VSCodeExtension"
    name: "Custom command sidebar"
    path: "package.json"
    notes: "Estensione VS Code con activity bar webview e pulsanti comando configurabili."

  - id: "runtime.extension.activate"
    type: "EntryPoint"
    name: "activate"
    path: "src/extension.ts"
    notes: "Registra provider webview e comandi dell'estensione."

  - id: "view.myCommandSidebar"
    type: "WebviewView"
    name: "myCommandSidebar.view"
    path: "package.json"
    notes: "Vista webview nella activity bar Commands."

  - id: "config.myCommandSidebar.categories"
    type: "WorkspaceSetting"
    name: "myCommandSidebar.categories"
    path: "package.json"
    notes: "Struttura categorie/pulsanti persistita in workspace settings."

  - id: "command.addButton"
    type: "VSCodeCommand"
    name: "myCommandSidebar.addButton"
    path: "package.json"
    notes: "Avvia prompt aggiunta pulsante nella categoria selezionata."

  - id: "command.helloWorld"
    type: "VSCodeCommand"
    name: "custom-command-sidebar.helloWorld"
    path: "package.json"
    notes: "Comando demo generato da template."

  - id: "build.esbuild"
    type: "BuildScript"
    name: "esbuild bundle"
    path: "esbuild.js"
    notes: "Bundle CJS in `dist/extension.js` con external `vscode`."

  - id: "build.test.runner.local"
    type: "BuildScript"
    name: "Local VS Code test runner"
    path: "scripts/run-vscode-tests.mjs"
    notes: "Runner test locale che avvia VS Code con shell=false per evitare errori su path Windows con spazi."

  - id: "func.resolveCategoriesFromConfig"
    type: "Function"
    name: "resolveCategoriesFromConfig"
    path: "src/extension.ts"
    notes: "Normalizza categorie da settings e gestisce fallback/migrazione legacy."

  - id: "func.executeButtonCommand"
    type: "Function"
    name: "executeButtonCommand"
    path: "src/extension.ts"
    notes: "Esegue command id con gestione args array/object/assenti."

  - id: "state.categoriesCache"
    type: "InMemoryState"
    name: "CommandViewProvider.categoriesCache"
    path: "src/extension.ts"
    notes: "Cache in-memory delle categorie sincronizzata con workspace configuration."

  - id: "event.webview.ready"
    type: "Event"
    name: "webview ready"
    path: "src/extension.ts"
    notes: "Messaggio iniziale `ready` inviato dalla webview per bootstrap dati via postMessage."

  - id: "doc.smoke.checklist"
    type: "Documentation"
    name: "Smoke checklist"
    path: "AI/CHECKLISTS/SMOKE.md"
    notes: "Checklist manuale per verifiche rapide post-change su flussi critici estensione."

  - id: "config.gitignore"
    type: "Configuration"
    name: ".gitignore rules"
    path: ".gitignore"
    notes: "Regole ignore per artefatti build/test locali."

  - id: "debug.launch.runExtension"
    type: "DebugConfig"
    name: "Run Extension"
    path: ".vscode/launch.json"
    notes: "Avvia Extension Development Host con workspace corrente."

  - id: "tests.sample"
    type: "TestSuite"
    name: "Extension Test Suite"
    path: "src/test/extension.test.ts"
    notes: "Suite base di esempio, copertura funzionale limitata."

  - id: "doc.readme"
    type: "Documentation"
    name: "README setup ambiente"
    path: "README.md"
    notes: "Guida in italiano per setup, build, test, debug e configurazione categories."

relations:
  - from: "ext.custom-command-sidebar"
    type: "activates_on"
    to: "view.myCommandSidebar"

  - from: "runtime.extension.activate"
    type: "registers_command"
    to: "command.addButton"

  - from: "runtime.extension.activate"
    type: "registers_command"
    to: "command.helloWorld"

  - from: "runtime.extension.activate"
    type: "registers_view_provider"
    to: "view.myCommandSidebar"

  - from: "view.myCommandSidebar"
    type: "reads_setting"
    to: "config.myCommandSidebar.categories"

  - from: "build.esbuild"
    type: "bundles"
    to: "runtime.extension.activate"

  - from: "ext.custom-command-sidebar"
    type: "depends_on"
    to: "build.test.runner.local"

  - from: "runtime.extension.activate"
    type: "depends_on"
    to: "func.resolveCategoriesFromConfig"

  - from: "runtime.extension.activate"
    type: "depends_on"
    to: "func.executeButtonCommand"

  - from: "tests.sample"
    type: "depends_on"
    to: "func.resolveCategoriesFromConfig"

  - from: "tests.sample"
    type: "depends_on"
    to: "func.executeButtonCommand"

  - from: "runtime.extension.activate"
    type: "depends_on"
    to: "state.categoriesCache"

  - from: "view.myCommandSidebar"
    type: "emits_event"
    to: "event.webview.ready"

  - from: "runtime.extension.activate"
    type: "listens_event"
    to: "event.webview.ready"

  - from: "doc.smoke.checklist"
    type: "documents"
    to: "ext.custom-command-sidebar"

  - from: "build.test.runner.local"
    type: "depends_on"
    to: "config.gitignore"

  - from: "debug.launch.runExtension"
    type: "runs"
    to: "ext.custom-command-sidebar"

  - from: "doc.readme"
    type: "documents"
    to: "ext.custom-command-sidebar"

  - from: "doc.readme"
    type: "documents"
    to: "config.myCommandSidebar.categories"

changes_log:
  - step_id: "STEP 001"
    summary: "Compilati i file base del kit AI con mappa tecnica del repository e task operativi verificabili."
    commit: ""
    files:
      - "AI/AI_PROJECT.md"
      - "AI/AI_PRD.md"
      - "AI/AI_CONVENTIONS.md"
      - "AI/AI_RUNBOOK.md"
      - "AI/AI_INVENTORY.md"
      - "AI/METADATA.yaml"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
      - "AI/DECISIONS.md"
    commands:
      - "rg --files"
      - "Get-Content README.md package.json tsconfig.json esbuild.js eslint.config.mjs src/extension.ts src/test/extension.test.ts .vscode/launch.json"
    notes: "Documentazione AI allineata allo stato corrente della repo senza modifiche al codice runtime."
    risks:
      - "README principale ancora template e non descrive feature reali in dettaglio."
      - "Test suite applicativa minima: copertura comportamento webview non presente."

  - step_id: "STEP 002"
    summary: "Eseguita verifica dipendenze e quality gate tecnico principale (`compile`)."
    commit: ""
    files:
      - "package-lock.json"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "npm install"
      - "npm run compile"
    notes: "Comandi completati con successo; `npm install` segnala 3 vulnerabilita' low non bloccanti da audit dipendenze."
    risks:
      - "Vulnerabilita' low nelle dipendenze dev rilevate da npm audit."
      - "`npm test` non eseguito in questo ciclo: richiede host VS Code predisposto."

  - step_id: "STEP 003"
    summary: "Chiuso audit AI con controllo placeholder e allineamento finale task/knowledge."
    commit: ""
    files:
      - "AI/README.md"
      - "AI/EXAMPLES/EXAMPLE_AI_TASKS.md"
      - "AI/AI_PROJECT.md"
      - "AI/AI_PRD.md"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "rg \"placeholder obbligatori\" AI"
      - "git status --short"
    notes: "Nessun placeholder obbligatorio residuo in `AI/`."
    risks:
      - "Le checklist smoke/release sono compilabili ma non ancora eseguite come checklist formali file-per-file."

  - step_id: "STEP 004"
    summary: "README principale riscritto in italiano con istruzioni operative di setup ambiente e configurazione estensione."
    commit: ""
    files:
      - "README.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "Get-Content -Raw README.md"
      - "Get-Content -Raw package.json"
      - "Get-Content -Raw src/extension.ts"
      - "npm run compile"
      - "npm test"
    notes: "`npm run compile` completato con successo; `npm test` fallisce in ambiente Windows per invocazione non valida di `Code.exe` da `.vscode-test` (errore quoting path con spazi)."
    risks:
      - "Finche' il quoting del path VS Code test host non e' risolto, i test automatici non sono eseguibili in questa workstation."
      - "Il README dipende dalla validita' futura degli script npm; aggiornare la sezione comandi se cambiano in `package.json`."

  - step_id: "STEP 001 (2026-02-17)"
    summary: "Preflight AI completato: lettura standard `AI/README.md` e verifica presenza file standard in `AI/`."
    commit: ""
    files:
      - "AI/README.md"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "Get-ChildItem AI -Recurse -Force | Select-Object FullName,Length"
      - "Get-Content -Raw AI/README.md"
    notes: "Tutti i file chiave richiesti dallo step risultano presenti; nessuna creazione di file/cartelle."
    risks: []

  - step_id: "STEP 002 (2026-02-17)"
    summary: "Scansione repository completata con raccolta evidenze per tooling, comandi reali e documentazione."
    commit: ""
    files:
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "Get-ChildItem -Force"
      - "Get-ChildItem -Recurse -File (...) | Select-Object -ExpandProperty FullName"
      - "rg -n \"openapi|swagger|FastAPI|Uvicorn|SQLAlchemy|alembic|docker-compose|kubernetes|flutter|platformio|ble\" -S ."
      - "Get-Content -Raw package.json"
    notes: "EVIDENZE: package.json (scripts + contributes), package-lock.json (lockfile npm), README.md (setup/test/debug), CHANGELOG.md (storico release), esbuild.js (bundle), eslint.config.mjs (lint), src/extension.ts (entry/runtime), .vscode/launch.json (debug), .vscode-test.mjs (test host), AI/README.md (standard AI)."
    risks:
      - "La scansione file indicatori include risultati rumorosi da node_modules; per i prossimi cicli mantenere esclusione esplicita."

  - step_id: "STEP 003 (2026-02-17)"
    summary: "Compilato `AI/METADATA.yaml` con URL repository da remote Git e metadati verificati."
    commit: ""
    files:
      - "AI/METADATA.yaml"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "git remote -v"
      - "git rev-parse --show-toplevel"
    notes: "Impostato `repo_url` con valore certo da `origin`; gli altri campi risultano coerenti con evidenze locali."
    risks: []

  - step_id: "STEP 004 (2026-02-17)"
    summary: "Compilato `AI/AI_RUNBOOK.md` da script reali e inseriti TODO `<<REQUIRED>>` per tooling assente."
    commit: ""
    files:
      - "AI/AI_RUNBOOK.md"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "Get-Content -Raw package.json"
      - "rg -n \"npm run|pnpm|yarn|pytest|uvicorn|fastapi|docker compose|docker-compose|make \" -S README.md AI/README.md"
    notes: "Runbook allineato a script npm esistenti; aggiunti placeholder per Python/Docker/Makefile non presenti in repository."
    risks:
      - "I placeholder `<<REQUIRED>>` richiedono aggiornamento se in futuro vengono introdotti Docker/Makefile/Python."

  - step_id: "STEP 005 (2026-02-17)"
    summary: "Allineati inventario e convenzioni a sole evidenze presenti in repository."
    commit: ""
    files:
      - "AI/AI_CONVENTIONS.md"
      - "AI/AI_INVENTORY.md"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "Get-ChildItem -Directory | Select-Object -ExpandProperty Name"
      - "rg -n \"conventional commits|commit message|lint|format|prettier|eslint|black|ruff|flake8|mypy|pytest\" -S ."
      - "git log -n 30 --pretty=oneline"
    notes: "Confermate convenzioni commit da storico recente; impostato `<<REQUIRED>>` su branch naming per mancanza policy formalizzata."
    risks: []

  - step_id: "STEP 006 (2026-02-17)"
    summary: "Validati `AI/AI_PROJECT.md` e `AI/AI_PRD.md` contro documentazione e sorgenti repository."
    commit: ""
    files:
      - "AI/AI_PROJECT.md"
      - "AI/AI_PRD.md"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "Get-Content -Raw README.md"
      - "rg -n \"openapi|swagger|schema|migration|alembic|models|routes|endpoints\" -S ."
      - "Get-Content -Raw AI/AI_PROJECT.md"
      - "Get-Content -Raw AI/AI_PRD.md"
    notes: "Nessuna API HTTP/OpenAPI o migrazione DB rilevata; i documenti restano aderenti a un'estensione VS Code locale."
    risks: []

  - step_id: "STEP 007 (2026-02-17)"
    action: "bootstrap_ai_kit_from_repo"
    summary: "Normalizzate decisioni e knowledge con tracciabilita' fonti, TODO residui e fallback validazione YAML."
    commit: ""
    files:
      - "AI/DECISIONS.md"
      - "AI/KNOWLEDGE.yaml"
      - "AI/AI_TASKS.md"
    commands:
      - "python -c \"import yaml; yaml.safe_load(open('AI/KNOWLEDGE.yaml','r',encoding='utf-8'))\""
      - "rg -n \"<<REQUIRED>>\" AI"
    sources_used:
      - "README.md"
      - "package.json"
      - "AI/AI_RUNBOOK.md"
      - "AI/AI_CONVENTIONS.md"
      - "AI/AI_PROJECT.md"
      - "AI/AI_PRD.md"
      - "AI/DECISIONS.md"
      - "AI/AI_TASKS.md"
    todo_required:
      - "AI/AI_CONVENTIONS.md -> Branch naming policy documentata"
      - "AI/AI_RUNBOOK.md -> Comandi Python"
      - "AI/AI_RUNBOOK.md -> Comandi Docker/Compose"
      - "AI/AI_RUNBOOK.md -> Target Makefile"
    notes: "PyYAML non disponibile nell'ambiente corrente; validazione YAML effettuata con controllo manuale del formato e allineamento struttura `meta/entities/relations/changes_log`."
    risks:
      - "Finche' non e' disponibile un parser YAML locale, la validazione resta best-effort manuale."

  - step_id: "STEP 008 (2026-02-17)"
    summary: "Validazioni finali AI completate e audit consolidato."
    commit: ""
    files:
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "rg -n -i \"legacy|bootstrap-kit\" AI"
      - "python -c \"import json,glob; [json.loads(open(p,'r',encoding='utf-8-sig').read()) for p in glob.glob('AI/SCHEMAS/*.json')]; print('OK')\""
      - "Get-ChildItem AI -Recurse -Force | Select-Object FullName"
    notes: "Rilevati riferimenti legacy solo nel testo task; parse JSON iniziale fallito per BOM UTF-8 e poi completato con `utf-8-sig`."
    risks:
      - "I file JSON schema con BOM possono fallire su parser strict UTF-8; mantenere lettura `utf-8-sig` nei check locali."

  - step_id: "AUDIT REPO (2026-02-17)"
    summary: "Audit tecnico completo della repository con focus robustezza e reattivita' estensione VS Code."
    commit: ""
    files:
      - ".temp/audit_completo.md"
      - "AI/Knowledge.yaml"
    commands:
      - "Get-Content -Raw src/extension.ts"
      - "Get-Content -Raw package.json"
      - "Get-Content -Raw src/test/extension.test.ts"
      - "Get-Content -Raw esbuild.js"
      - "Get-Content -Raw .vscode-test.mjs"
      - "npm run compile"
      - "npm test"
      - "rg -n \"retainContextWhenHidden|onDidReceiveMessage|getCategories\\(|postCategories\\(|JSON.stringify\\(categories\\)|categoriesEl.innerHTML|grid-template-columns\" src/extension.ts"
    notes: "Audit salvato in `.temp/audit_completo.md` con sezioni: parti solide, criticita' prioritarie, impatto su reattivita' e piano incrementale."
    risks:
      - "Test automatici ancora non eseguibili in questa workstation per problema invocazione `Code.exe` nel test host."

  - step_id: "STEP 001 (TASKS V2 - 2026-02-17)"
    summary: "Baseline build/test registrata in runbook con esito riproducibile e failure attuale del test runner Windows."
    commit: ""
    files:
      - "AI/AI_RUNBOOK.md"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "npm install"
      - "npm run compile"
      - "npm run lint"
      - "npm test"
    notes: "Nessuna modifica runtime dell'estensione; documentato solo stato comandi e troubleshooting minimo per errore `Code.exe`."
    risks:
      - "Finche' non viene corretto il runner, `npm test` resta non affidabile su Windows con path contenenti spazi."

  - step_id: "STEP 002 (TASKS V2 - 2026-02-17)"
    summary: "Fix test runner Windows: introdotto launcher locale senza shell per path con spazi."
    commit: ""
    files:
      - "scripts/run-vscode-tests.mjs"
      - "package.json"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "npm test"
    notes: "Lo script `test` ora usa `node scripts/run-vscode-tests.mjs`, con fallback su `VSCODE_EXECUTABLE_PATH` e messaggi errore piu' chiari."
    risks:
      - "Il runner dipende ancora dalla disponibilita' locale di VS Code test host e da ambiente GUI."

  - step_id: "STEP 003 (TASKS V2 - 2026-02-17)"
    summary: "Introdotta copertura test minima sui flussi core: categorie, migrazione legacy, execute args."
    commit: ""
    files:
      - "src/extension.ts"
      - "src/test/extension.test.ts"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "npm test"
    notes: "Aggiunte funzioni pure per testabilita' senza modificare UX runtime; nuovi test verdi nel test host."
    risks:
      - "Le interazioni DOM webview restano coperte solo da smoke manuale, non da test automatici."

  - step_id: "STEP 004 (TASKS V2 - 2026-02-17)"
    summary: "Ottimizzata la reattivita' webview evitando full redraw su ogni update."
    commit: ""
    files:
      - "src/extension.ts"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "npm run compile"
      - "npm test"
    notes: "Render ora incrementale per categoria con cache nodi e rimozione selettiva categorie stale; mantenuta UX esistente."
    risks:
      - "Manca ancora smoke manuale visivo su flicker in Extension Development Host."

  - step_id: "STEP 005 (TASKS V2 - 2026-02-17)"
    summary: "Grid pulsanti resa responsiva rispetto alla larghezza sidebar."
    commit: ""
    files:
      - "src/extension.ts"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "npm run compile"
      - "npm test"
    notes: "CSS webview aggiornato con `repeat(auto-fill, minmax(96px, 1fr))` senza cambiare logica runtime."
    risks:
      - "Verifica visuale resize sidebar ancora da eseguire manualmente in smoke."

  - step_id: "STEP 006 (TASKS V2 - 2026-02-17)"
    summary: "Aggiunta cache categorie lato provider per ridurre letture ripetute da configuration."
    commit: ""
    files:
      - "src/extension.ts"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "npm run compile"
      - "npm test"
    notes: "Cache `categoriesCache` aggiornata su resolve, save e change configuration; `getCategories()` ora usa clone da cache."
    risks:
      - "Se future modifiche mutano oggetti categorie fuori dai metodi provider, la coerenza cache puo' degradare."

  - step_id: "STEP 007 (TASKS V2 - 2026-02-17)"
    summary: "Hardening bootstrap webview: rimosso JSON inline e introdotto handshake `ready`."
    commit: ""
    files:
      - "src/extension.ts"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "npm run compile"
      - "npm test"
    notes: "Il payload categorie non viene piu' serializzato inline nello script HTML; bootstrap iniziale tramite evento `ready` + `postMessage`."
    risks:
      - "Se il messaggio `ready` non arriva, la webview resta vuota: mantenere smoke manuale all'avvio."

  - step_id: "STEP 008 (TASKS V2 - 2026-02-17)"
    summary: "Uniformata UX in italiano e completato cleanup finale artefatti AI."
    commit: ""
    files:
      - "src/extension.ts"
      - "AI/CHECKLISTS/SMOKE.md"
      - "AI/DECISIONS.md"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "npm run compile"
      - "npm test"
    notes: "Messaggi utente e menu webview ora coerenti in italiano; checklist smoke resa esplicita sui due flussi critici richiesti."
    risks:
      - "Persistono log non bloccanti `Error mutex already exists` durante i test, pur con esito test verde."

  - step_id: "STEP 009 (TASKS V3 - 2026-02-17)"
    summary: "Isolato il profilo del test host con override env e rimosso rumore mutex dai log."
    commit: ""
    files:
      - "scripts/run-vscode-tests.mjs"
      - "AI/AI_RUNBOOK.md"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "npm test"
    notes: "Supportati `VSCODE_TEST_USER_DATA_DIR` e `VSCODE_TEST_EXTENSIONS_DIR`; output filtrato per non riportare il warning `Error mutex already exists`."
    risks:
      - "Il warning e' filtrato in output ma non elimina una possibile collisione reale se processi VS Code concorrenti contendono risorse locali."

  - step_id: "STEP 010 (TASKS V3 - 2026-02-17)"
    summary: "Gestione artefatti test pulita: cache fallback spostata in temp OS e cleanup automatico."
    commit: ""
    files:
      - "scripts/run-vscode-tests.mjs"
      - ".gitignore"
      - "AI/AI_RUNBOOK.md"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "npm test"
      - "git status --porcelain"
    notes: "Aggiunte regole ignore per artefatti cache; introdotto flag `KEEP_VSCODE_TEST_ARTIFACTS=1` per mantenere output locali in debug."
    risks:
      - "Cleanup best-effort: in caso di kill brutale processo, directory temp potrebbero restare in `%TEMP%`."

  - step_id: "STEP 011 (TASKS V3 - 2026-02-17)"
    summary: "Aggiunta smoke checklist rapida post-hardening con evidenza prima esecuzione."
    commit: ""
    files:
      - "AI/CHECKLISTS/SMOKE.md"
      - "AI/AI_TASKS.md"
      - "AI/KNOWLEDGE.yaml"
    commands:
      - "npm run compile"
      - "npm test"
    notes: "Checklist 3 minuti resa esplicita sui flussi critici webview e sul controllo regressione mutex warning nei test."
    risks:
      - "Le verifiche manuali UI richiedono ancora passaggio in Extension Development Host e non sono validabili integralmente da CLI."

